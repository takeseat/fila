// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Restaurant {
  id        String   @id @default(uuid())
  name      String
  tradeName String?  // Optional trade/fantasy name
  cnpj      String?
  phone     String?  // Optional - user phone is collected instead
  email     String?  // Optional - user email is collected instead
  
  // Internationalized Address
  countryCode        String?  @default("BR") // ISO 3166-1 alpha-2
  stateCode          String?  // State/Province/Region code
  city               String
  addressLine        String?  // Street address
  addressNumber      String?  // Building number
  addressComplement  String?  // Apartment, suite, etc.
  postalCode         String?  // ZIP/CEP/Postal code
  
  timezone  String   @default("America/Sao_Paulo")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Alert Settings
  waitingAlertMinutes Int?
  calledAlertMinutes  Int?
  
  // Average Wait Time Settings
  avgWaitWindowMinutes   Int?     @default(90)
  avgWaitFallbackMinutes Int?     @default(15)

  users           User[]
  waitlistEntries WaitlistEntry[]
  customers       Customer[]

  @@map("restaurants")
}

model User {
  id           String   @id @default(uuid())
  restaurantId String
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(MANAGER)
  language     String   @default("en")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  HOSTESS
}

model Customer {
  id           String    @id @default(uuid())
  restaurantId String
  name         String
  countryCode  String    // ISO 3166-1 alpha-2: "BR", "US", "PT"
  ddi          String    // "+55", "+1", "+351"
  phone        String    // Local phone without DDI: "11999999999"
  fullPhone    String    // Complete international: "+5511999999999"
  email        String?
  notes        String?   @db.Text
  lastVisitAt  DateTime? // Last time customer was seated
  totalVisits  Int       @default(0) // Total number of completed visits
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  restaurant       Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  waitlistEntries  WaitlistEntry[]

  @@unique([restaurantId, fullPhone])
  @@index([restaurantId])
  @@index([fullPhone])
  @@index([email])
  @@map("customers")
}

model WaitlistEntry {
  id                   String              @id @default(uuid())
  restaurantId         String              @map("restaurant_id")
  customerId           String?             @map("customer_id")
  customerName         String              @map("customer_name")
  customerPhone        String              @map("customer_phone")
  customerCountryCode  String?             @map("customer_country_code")
  partySize            Int                 @map("party_size")
  status               WaitlistEntryStatus @default(WAITING)
  estimatedWaitMinutes Int?                @map("estimated_wait_minutes")
  createdAt            DateTime            @default(now()) @map("created_at")
  calledAt             DateTime?           @map("called_at")
  seatedAt             DateTime?           @map("seated_at")
  cancelledAt          DateTime?           @map("cancelled_at")
  noShowAt             DateTime?           @map("no_show_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([restaurantId, status])
  @@index([customerId])
  // Analytics indexes for efficient reporting
  @@index([restaurantId, createdAt])
  @@index([restaurantId, status, createdAt])
  @@index([restaurantId, seatedAt])
  @@index([restaurantId, calledAt])
  @@map("waitlist_entries")
}

enum WaitlistEntryStatus {
  WAITING
  CALLED
  SEATED
  CANCELLED
  NO_SHOW
}

