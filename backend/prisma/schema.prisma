// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Restaurant {
  id        String   @id @default(uuid())
  name      String
  cnpj      String?
  phone     String
  email     String
  city      String
  timezone  String   @default("America/Sao_Paulo")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Alert Settings
  waitingAlertMinutes Int?
  calledAlertMinutes  Int?
  
  // Average Wait Time Settings
  avgWaitWindowMinutes   Int?     @default(90)
  avgWaitFallbackMinutes Int?     @default(15)

  users           User[]
  waitlistEntries WaitlistEntry[]
  customers       Customer[]

  @@map("restaurants")
}

model User {
  id           String   @id @default(uuid())
  restaurantId String
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(MANAGER)
  language     String   @default("en")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  HOSTESS
}

model Customer {
  id           String    @id @default(uuid())
  restaurantId String
  name         String
  countryCode  String    // ISO 3166-1 alpha-2: "BR", "US", "PT"
  ddi          String    // "+55", "+1", "+351"
  phone        String    // Local phone without DDI: "11999999999"
  fullPhone    String    // Complete international: "+5511999999999"
  email        String?
  notes        String?   @db.Text
  lastVisitAt  DateTime? // Last time customer was seated
  totalVisits  Int       @default(0) // Total number of completed visits
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  restaurant       Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  waitlistEntries  WaitlistEntry[]

  @@unique([restaurantId, fullPhone])
  @@index([restaurantId])
  @@index([fullPhone])
  @@index([email])
  @@map("customers")
}

model WaitlistEntry {
  id                   String              @id @default(uuid())
  restaurantId         String
  customerId           String?
  customerName         String
  customerPhone        String
  customerCountryCode  String?
  partySize            Int
  status               WaitlistEntryStatus @default(WAITING)
  estimatedWaitMinutes Int?
  createdAt            DateTime            @default(now())
  calledAt             DateTime?
  seatedAt             DateTime?
  cancelledAt          DateTime?
  noShowAt             DateTime?

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  customer   Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([restaurantId, status])
  @@index([customerId])
  @@map("waitlist_entries")
}

enum WaitlistEntryStatus {
  WAITING
  CALLED
  SEATED
  CANCELLED
  NO_SHOW
}

